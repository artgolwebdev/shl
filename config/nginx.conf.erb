daemon off;
#Heroku dynos have at least 4 cores.
worker_processes <%= ENV['NGINX_WORKERS'] || 4 %>;

events {
	use epoll;
	accept_mutex on;
	worker_connections 1024;
}

http {
	gzip on;
	gzip_comp_level 2;
	gzip_min_length 512;
	gzip_proxied any;
	gzip_vary on;
	gzip_types
		text/plain
		text/css
		text/js
		text/xml
		text/javascript
		application/json
		application/javascript
		application/xml+rss
		application/vnd.ms-fontobject
		application/x-font-ttf
		application/x-web-app-manifest+json
		application/xhtml+xml
		application/xml
		font/opentype
		image/svg+xml
		image/x-icon;

	server_tokens off;

	log_format l2met 'measure#nginx.service=$request_time request_id=$http_x_request_id';
	access_log logs/nginx/access.log l2met;
	error_log logs/nginx/error.log;

	include mime.types;
	default_type application/octet-stream;
	sendfile on;

	#Must read the body in 5 seconds.
	client_body_timeout 5;

	upstream app {
		server unix:/tmp/nginx.socket fail_timeout=0;
	}

	server {
		listen <%= ENV["PORT"] %>;
		server_name _;
		keepalive_timeout 5;
		root /app;

		# Security headers
		add_header X-Content-Type-Options "nosniff" always;
		add_header X-Frame-Options "DENY" always;
		add_header X-XSS-Protection "1; mode=block" always;
		add_header Referrer-Policy "strict-origin-when-cross-origin" always;

		# Language routing
		location = /ar {
			rewrite ^ /index-ar.html last;
		}

		location = /en {
			rewrite ^ /index-en.html last;
		}

		location = / {
			rewrite ^ /index.html last;
		}

		# Sitemap and robots
		location ~ \.(xml|txt)$ {
			expires 1d;
			add_header Cache-Control "public, immutable";
		}

		# Static files
		location ~* \.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot)$ {
			expires 1y;
			add_header Cache-Control "public, immutable";
		}

		# HTML files
		location ~ \.html$ {
			expires -1;
			add_header Cache-Control "no-cache, no-store, must-revalidate";
		}

		# Default location
		location / {
			try_files $uri $uri/ =404;
		}
	}
}

